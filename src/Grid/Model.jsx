/*
Auto-generated by: https://github.com/pmndrs/gltfjsx
*/

import { animated, useTransition } from '@react-spring/three';
import { useGLTF } from "@react-three/drei";
import { useDispatch } from "react-redux";
import { gridActions } from '../store/grid';
import { togglePlacedPreview } from "../store/ui";
import { modelActions } from "../store/model";
import { useAppSelector } from "../store/hooks";


const Model = ({ name, rotation, color, ...props }) => {
    const { nodes } = useGLTF("./models/model_0.gltf");
    const useWireframe = !props.wireframe;

    return (
        <group name="1x1" scale={[1, 0.8, 1]} position={[-0.5, 0.5, -0.5]}>
            {useWireframe && <mesh
                castShadow
                receiveShadow
                name={name}
                geometry={nodes[name].geometry}
                position={[0.5, -1.25, 0.5]}
                rotation={[0, rotation, 0]}
            >
                <meshLambertMaterial color={color} />
            </mesh>}
            <lineSegments name="wire" position={[0.5, -1.25, 0.5]} rotation={[0, rotation, 0]}>
                <edgesGeometry attach="geometry" args={[nodes[name].geometry, 30]} />
                <lineBasicMaterial attach="material" color="black" />
            </lineSegments>
        </group>
    );
};

const ModelMobile = ({ name, rotation, color, ...props }) => {
    const { nodes } = useGLTF("./models/model_0.gltf");
    const useWireframe = !props.wireframe;
    const dispatch = useDispatch();
    const previewBlockIds = useAppSelector(state => state.ui.previewBlockIds);
    const nextModel = useAppSelector(state => state.model.model);

    const handleClick = (e) => {
        dispatch(togglePlacedPreview());
        dispatch(gridActions.addBlock({ faceId: previewBlockIds.faceId, blockId: previewBlockIds.blockId, model: nextModel }));
        setTimeout(function () {
            dispatch(modelActions.randomBlock());
        }, 100);
        e.stopPropagation();
    }

    return (
        <group name="1x1" scale={[1, 0.8, 1]} position={[-0.5, 0.5, -0.5]}>
            {useWireframe && <mesh
                onClick={handleClick}
                castShadow
                receiveShadow
                name={name}
                geometry={nodes[name].geometry}
                position={[0.5, -1.25, 0.5]}
                rotation={[0, rotation, 0]}
            >
                <meshLambertMaterial color={color} />
            </mesh>}
            <lineSegments name="wire" position={[0.5, -1.25, 0.5]} rotation={[0, rotation, 0]}>
                <edgesGeometry attach="geometry" args={[nodes[name].geometry, 30]} />
                <lineBasicMaterial attach="material" color="black" />
            </lineSegments>
        </group>
    );
};

const ModelAnimated = ({ name, rotation, color, ...props }) => {
    const transition = useTransition(true, {
        from: { scale: [0.8, 0.8, 0.8] },
        enter: { scale: [1, 1, 1] },
        leave: () => { console.log("leaving"); return { scale: [0.1, 0.1, 0.1] } },
        config: { mass: 1, tension: 2000, friction: 80 },
    });

    return (
        <>
            {transition((props, item) => item &&
                <>
                    <animated.group dispose={null} scale={props.scale}>
                        <Model name={name} rotation={rotation} color={color} wireframe={props.wireframe} {...props}></Model>
                    </animated.group>
                </>
            )}
        </>
    );
}

export default Model;
export { ModelAnimated, ModelMobile };
